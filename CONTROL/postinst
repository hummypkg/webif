#!/bin/sh

echo "Postinstall $*"

export tmpf=/tmp/cronf.$$

# Add cron jobs

crond=$PKG_ROOT/var/spool/cron/crontabs
[ -d $crond ] || exit 1

cronf=$crond/root
grep -v webif/lib/bin/auto $cronf > $tmpf
(
	cat $tmpf
	echo '*/10 * * * * /mod/webif/lib/bin/auto >/dev/null 2>&1'
) > $cronf

# Add anacron jobs

ana=$PKG_ROOT/etc/anacrontab
egrep -v 'backup/backup.jim|diskattrs' $ana > $tmpf
(
	cat $tmpf
	echo "1 8 sched_backup /mod/var/mongoose/cgi-bin/backup/backup.jim"
	echo "1 5 diskattrs /mod/webif/lib/bin/diskattrs"
) > $ana

$PKG_ROOT/etc/init.d/S02anacron start < /dev/null > /dev/null 2>&1 &

[ -f /tmp/webif_auto.log ] && rm -f /tmp/webif_auto.log

if [ ! -f /mod/webif/.strip-updated ]; then
	echo "*********************************"
	echo "* Please wait while any shrunk recordings are flagged..."
	echo "*********************************"
	/mod/webif/lib/bin/strip-update

	touch /mod/webif/.strip-updated
fi

/mod/webif/lib/bin/diskattrs

exit 0

