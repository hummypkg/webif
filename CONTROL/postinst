#!/bin/sh

echo "Postinstall $*"

export tmpf=/tmp/cronf.$$

# Add cron jobs

crontab=$PKG_ROOT/bin/crontab
if [ -x $crontab ]; then
	$crontab -l | grep -v webif/lib/bin/auto > $tmpf
	cat $tmpf - << EOM | $crontab -
*/10 * * * * /mod/webif/lib/bin/auto >/dev/null 2>&1
EOM
fi

# Add anacron jobs

ana=$PKG_ROOT/etc/anacrontab
egrep -v 'backup/backup.jim|bin/diskattrs' $ana > $tmpf
cat $tmpf - << EOM > $ana
1 8 sched_backup /mod/webife/cgi-bin/backup/backup.jim
1 5 diskattrs /mod/webif/lib/bin/diskattrs
EOM

$PKG_ROOT/etc/init.d/S02anacron start < /dev/null > /dev/null 2>&1 &

[ -f /tmp/webif_auto.log ] && rm -f /tmp/webif_auto.log

if [ ! -f /mod/webif/.strip-updated ]; then
	echo "*********************************"
	echo "* Please wait while any shrunk recordings are flagged..."
	echo "*********************************"
	/mod/webif/lib/bin/strip-update

	touch /mod/webif/.strip-updated
fi

/mod/webif/lib/bin/diskattrs

[ -f $tmpf ] && rm -f $tmpf

exit 0

